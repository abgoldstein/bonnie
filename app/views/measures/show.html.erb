<% content_for :head do %>
  <script type="text/javascript">
    var bonnie = bonnie || {};
    bonnie.renderMeasureJSON = function(data) {
        var measure = data;
        var elemParent;
        var addParamItems = function(obj,elemParent,container) {
          var items = obj['and'] || obj['or'];
          if ($.isArray(items)) {
            var conjunction = obj['and'] ? 'and' : 'or';
            // add the grouping container
            if (!container) {elemParent = $("#ph_tmpl_paramGroup").tmpl({}).appendTo(elemParent).find(".paramItem:last");}
              $.each(items,function(i,node) {
                addParamItems(node,elemParent);
                if (i < items.length-1) {
                  $(elemParent).append("<span class='"+conjunction+"'>"+conjunction+"</span>");
                }
              });
            } else {
              // we dont have a nested measure clause, add the item to the bottom of the list
              if (!elemParent.hasClass("paramItem")) {
                elemParent = $("#ph_tmpl_paramGroup").tmpl({}).appendTo(elemParent).find(".paramItem:last");
              }
              $("#ph_tmpl_paramItem").tmpl(obj).appendTo(elemParent);
            }
        } // end addParamItems

        if (data.population) {
          elemParent = $("#ph_tmpl_paramGroup").tmpl({}).appendTo("#eligibilityMeasureItems").find(".paramItem:last");
          addParamItems(data.population,elemParent,elemParent);
          elemParent.parent().addClass("population");
        }

        if (!$.isEmptyObject(data.denominator)) {
          $("#eligibilityMeasureItems").append("<span class='and'>and</span>");
          addParamItems(data.denominator,$("#eligibilityMeasureItems"));
        }

        if (data.numerator) {
          addParamItems(data.numerator,$("#outcomeMeasureItems"));
        }

        if ('exclusions' in data && !$.isEmptyObject(data['exclusions'])) {
          addParamItems(data.exclusions,$("#exclusionMeasureItems"));
          $("#exclusionMeasureItems").hide();
          $("#exclusionPanel").show();
        }
     }
    
    $(document).ready(function() {
      $.getJSON("<%= definition_measure_url(@measure) %>", bonnie.renderMeasureJSON);
    });
  </script>
  
  <script type="text/html" id="ph_tmpl_paramItem">
    <div>
      <!-- ${percentage=Math.round(Math.random()*100,2)} -->
      {{if category}}<label>${category}</label>{{/if}}
      ${title}
    </div>
  </script>
  <script type="text/html" id="ph_tmpl_paramGroupContainer">
    <div class="paramGroupContainer"></div>
  </script>
  <script type="text/html" id="ph_tmpl_paramGroup">
    <div class="paramGroup">
      <div class="paramItem"></div>
    </div>
  </script>
<% end %>

<% content_for :right_column do %>
	<p id="notice"><%= notice %></p>
	
	<div class="measureDetailTable" id="measureDetailTitle">
  	<dl>
      <dt style="line-height:2.5em">Measure Name:</dt>
      <dd><h1 id="measureTitleText"><%= "#{@measure.endorser}#{@measure.measure_id} #{@measure.title}" %></h1></dd>
    </dl>
    <dl>
      <dt>Reporting Period:</dt>
      <dd>
        <span id="measurementPeriod"><% @measure.measure_period %></span>
      </dd>
    </dl>
    <dl>
      <dt>Description:</dt>
       <dd>
         <span id="measureDescText"><%= @measure.description %></span>
       </dd>
    </dl>
    <% if @measure.published %>
      <dl>
  		  <dt>Version</dt>
    		<dd><%= "#{@measure.version} as of #{@measure.publish_date}" %></dd>
  	  </dl>
    <% end %>
  </div>
	
	<div id="measureEditContainer">
    <div id="eligibilityMeasures">
      <h3>DENOMINATOR</h3>
      <div class="measureBox">
        <div id="eligibilityMeasureItems"></div>
      </div>
    </div>
    
    <div id="outcomeMeasures">
      <h3>NUMERATOR</h3>
      <div class="measureBox">
        <div id="outcomeExclusionMarker" class="exclusionTab" style="display:none">
          Exclusions
        </div>
        <div id="outcomeMeasureItems"></div>
        <div id="xexclusionMeasureItems"></div>
      </div>
    </div>
  </div>

  <%= link_to 'Export', export_measure_path(@measure) %> |
  <%= link_to 'Publish', publish_measure_path(@measure) %> |
	<%= link_to 'Edit', edit_measure_path(@measure) %> |
	<%= link_to 'NQF Definition', show_nqf_measure_path(@measure), :target => "_blank" %> |
	<%= link_to 'Back', measures_path %>
<% end -%>