<% content_for :head do %>
  <script type="text/javascript" src="/assets/jquery-ui-1.8.21.min.js"></script>
  <script type="text/javascript" src="/assets/jquery.bbq.min.js"></script>
  <script type="text/javascript">
    var bonnie = bonnie || {};

    var flushDrop = function(e){
      e = e || $('#dragged').parents('.temporal_drop_zone');
      $(e).find('.temporal_reference_value').val('');
      $(e).find('.temporal_drop_label').text('Drop Reference Here');
      $(e).find('.close').hide();
      $(e).removeClass('fullDrop');
      $(e).not($('.temporal_drop_zone:first-child')).remove();
    }

    var fillDrop = function(obj, id){
      id = id || $(obj).find('.temporal_reference_value').val() || ($('#dragged').length && 'dragged');
      //(obj.originalEvent && obj.originalEvent.dataTransfer && obj.originalEvent.dataTransfer.getData('text'));
      obj = (obj.target && ($(obj.target).hasClass('temporal_drop_zone') ? obj.target : $(obj.target).parents('.temporal_drop_zone'))) || obj;

      // Disallow dropping a reference on a reference
      if ($('#' + id).hasClass('temporal_drop_zone_element')) return;

      $(obj).find('.temporal_reference_value').val(id);

      var $e
      $(obj).find('.temporal_drop_label').empty().append(
        id ? (
          $(obj).find('.close').show() &&
          $(obj).addClass('fullDrop') &&
          ($e = $('#' + id)).length ? $e.clone().attr('id', null) : $(document.createElement('div')).attr('draggable', 'true').text(id)
        ).addClass('temporal_drop_zone_element') : 'Drop Reference Here'
      );
    }

    var page = new Page(<%= @measure.data_criteria.to_json.html_safe %>, <%= @measure.measure_period.to_json.html_safe %>)
    $(document).ready(function() {
      page.initialize();
      $.getJSON($.bbq.getState('population') || "<%= url_for :action => 'definition' %>", bonnie.builder.renderMeasureJSON);
      $("#measureDetailBorder").click(function() {
        var md = $("#measureDetailInformation");
        md.css('left') == '0px' ?
          md.find('.inner').animate({right: 285}) | md.animate({left: -285}) | $("#tabs").animate({'margin-left': 15}) :
          md.animate({left: 0}) | md.find('.inner').animate({right: 0}) | $("#tabs").animate({"margin-left": 300});
        $("#measureDetailBorder i").toggleClass("icon-backward").toggleClass("icon-forward");
      });
      var measureDetail = $("#measureDetailInformation");
      var matchTitleHeight = function() {
        var h = $("h1.measure-title").height();
        measureDetail.css("padding-top",h+20);
        measureDetail.find("#measureDetailBorder i").css("margin-top",h+30);
      };
      $(window).on("resize",matchTitleHeight);
      matchTitleHeight();
      $('#selector > select').change(
        function(){
          $.bbq.pushState({population: $(this).val()});
          $("#initialPopulationItems, #eligibilityMeasureItems, #outcomeMeasureItems, #exclusionMeasureItems").empty();
          $.getJSON($(this).val(), bonnie.builder.renderMeasureJSON);
        }
      )

      $(document.body).on('dragstart', '.logicLeaf, #MeasurePeriod, .temporal_drop_zone_element',
        function(e){
          //e.originalEvent.dataTransfer.setData('text', !$(e.target).hasClass('temporal_drop_zone_element') ? $(e.target).attr('id') : JSON.stringify(e.target));
          e.originalEvent.dataTransfer.setData('text', 'TODO');
          if (!$(e.target).hasClass('temporal_drop_zone_element')) fillDrop($('#bonnie_tmpl_data_criteria_temporal_drop_zone').tmpl().insertAfter($('.temporal_reference .temporal_drop_zone:last-child')));
          $(e.target).attr('id', 'dragged')
        }
      );
      $(document.body).on('dragover',
        function(e){
          e.preventDefault();
          //if (e.originalEvent.dataTransfer.getData('text') == 'temporal_drop_zone_element' || $.inArray(e.target, $('.temporal_drop_zone, .temporal_drop_zone *')) > -1) e.preventDefault();
          //if (e.originalEvent.dataTransfer.getData('text') == 'temporal_drop_zone_element' || $.inArray(e.target, $('.temporal_drop_zone, .temporal_drop_zone *')) > -1) e.preventDefault();
        }
      );

      $(document.body).on('drop',
        function(e){
          if ($.inArray(e.target, $('.temporal_drop_zone, .temporal_drop_zone *')) > -1) fillDrop(e);
          else flushDrop();//if (e.originalEvent.dataTransfer.getData('text') == 'temporal_drop_zone_element') flushDrop('#temporal_drop_zone');
          $('.temporal_reference .temporal_drop_zone').not('.fullDrop').not($('.temporal_drop_zone:first-child')).remove();
        }
      );

      $(document.body).on('click', '.temporal_drop_zone .close',
        function(e){
          flushDrop($(e.target).parent());
        }
      );

    });

  </script>

  <script type="text/html" id="bonnie_tmpl_param_group">
    <div class='paramGroup'>
      <div class='paramItem'></div>
    </div>
  </script>

  <script type="text/html" id="bonnie_tmpl_data_criteria_logic">
    <div draggable="true" class='paramText {{if category}}${category}{{/if}} logicLeaf' {{if id}}id='${id}'{{/if}}>
      {{if operator}}<label>${operator}</label>{{/if}}
      {{if category}}<label>${category}</label>{{/if}}
      ${title} ${temporalText}
    </div>
  </script>

  <script type="text/html" id="bonnie_tmpl_data_criteria_temporal_drop_zone">
    <div draggable="true" class="temporal_drop_zone paramItem">
      <input class="temporal_reference_value" type="hidden"{{if reference}} value="${reference}"{{/if}} />
      <div class="temporal_drop_label"></div>
      <div class="close">&times;</div>
    </div>
  </script>

  <script type="text/html" id="bonnie_tmpl_data_criteria_edit">
    <div style="position: relative; border-radius:12px;padding:10px; border:1px solid #aaa;background-color:#CCC;">
    <div style="width: 0px; height: 0px;"><!-- This is crap. --><span class="arrow-w" style="position: relative; top: 45px; left: -88px;"></span></div>
      <%= form_tag({:action => 'update_criteria'}, {:onsubmit => "return bonnie.builder.editDataCriteria_submit(this)"}) do %>
        <input type="hidden" name="id" value="<%= params[:id] %>" />
        <input type="hidden" name="criteria_id" value="${id}">
        <div>${title}</div>
        <table>
          <tr>
            <td>Status:</td>
            <td>
              <select name="status">
                <option value="">--</option>
                <option value="ordered">Ordered</option>
                <option value="administered">Administered</option>
                <option value="active">Active</option>
              </select>
            </td>
          </tr>
          <tr>
            <td>Type:</td>
            <td>
              <select name="type">
                <option value="">--</option>
                <option value="encounterOutpatient">encounter outpatient</option>
                <option value="activeDiagnoses">active diagnoses</option>
              </select>
            </td>
          </tr>
          <tr>
            <td>Standard Category:</td>
            <td>
              <input name="standard_category" type="text" value="${standard_category || ''}"/>
            </td>
          </tr>
          <tr>
            <td>QDS Data Type:</td>
            <td>
              <input name="qds_data_type" type="text" value="${qds_data_type || ''}"/>
            </td>
          </tr>
          {{each temporal_references}}
          <tr>
            <td>Temporal:</td>
            <td class="temporal_reference">
              <div>
                <select class="temporal_type">
                  <option value="">--</option>
                  <option value="CONCURRENT">Concurrent with</option>
                  <option value="DURING">During</option>
                  <option value="EAE">Ends After End of</option>
                  <option value="EAS">Ends After Start of</option>
                  <option value="EBE">Ends Before End of</option>
                  <option value="EBS">Ends Before Start of</option>
                  <option value="ECW">Ends Concurrent with</option>
                  <option value="EDU">Ends During</option>
                  <option value="SAE">Starts After End of</option>
                  <option value="SAS">Starts After Start of</option>
                  <option value="SBE">Starts Before End of</option>
                  <option value="SBS">Starts Before Start of</option>
                  <option value="SCW">Starts Concurrent with</option>
                  <option value="SDU">Starts During</option>
                </select>
              </div>
              <div>
                <select class="temporal_relation" style="width: 60px;">
                  <option value="">--</option>
                  <option value="gt">&gt;</option>
                  <option value="gte">&gt;=</option>
                  <option value="lte">&lt;=</option>
                  <option value="lt">&lt;</option>
                </select>
                <input class="temporal_value" type="text" style="width: 60px;" value=""/>
                <select class="temporal_unit" style="width: 80px;">
                  <option value="">--</option>
                  <option value="a">yrs</option>
                  <option value="d">days</option>
                  <option value="h">hrs</option>
                  <option value="min">mins</option>
                  <option value="mo">mo.</option>
                  <option value="s">secs</option>
                  <option value="wk">wks</option>
                </select>
              </div>
              {{tmpl($value) '#bonnie_tmpl_data_criteria_temporal_drop_zone'}}
            </td>
          </tr>
          {{/each}}
          <tr>
            <td></td>
            <td><input type="submit" value="save"><span id="edit_save_message"></span></td>
          </tr>
          </tr>
        </table>
      <% end %>
    </div>
  </script>


<% end %>

<% content_for :page_content do %>

  <div class="pull-right" id="pageButtons">
    <a href="#" class="btn" >Save</a>
    <%= link_to 'Test', debug_measure_url(@measure), :class => 'btn' %>
    <a class="btn" data-toggle="modal" data-show="false" href="#publishConfirm">Publish</a>
  </div>
	<h1 class="measure-title"><%= "#{@measure.endorser}#{@measure.measure_id}: #{@measure.title}" %></h1>


  <div id="measureDetailInformation">
    <div id="measureDetailBorder"><i class="icon-backward icon-white"></i></div>
    <div class="inner" style="position:relative; margin:15px 20px 15px 15px;">
      <dl>
        <dt>Reporting Period:</dt>
        <dd>
          <span id="measurementPeriod"><% @measure.measure_period %></span>
        </dd>
      </dl>
      <dl>
        <dt>Description:</dt>
         <dd>
           <span id="measureDescText"><%= @measure.description %></span>
         </dd>
      </dl>
      <% if @measure.published %>
        <dl>
          <dt>Version</dt>
          <dd><%= "#{@measure.version} as of #{@measure.publish_date}" %></dd>
        </dl>
      <% end %>
      <%= link_to 'Export', export_measure_path(@measure) %> |
      <%= link_to 'Edit', edit_measure_path(@measure) %> |
      <%= link_to 'NQF Definition', show_nqf_measure_path(@measure), :target => "_blank" %> |
      <%= link_to 'Back', measures_path %>

      <div id="dataCriteria">
        <%= render partial: 'data_criteria', locals: {criteria_by_category: data_criteria_by_category(@measure.unique_data_criteria)}%>
      </div>
    </div>
  </div>

  <!-- start tab nav -->
  <div id="tabs" class="measureDetailTable">

    <p id="notice"><%= notice %></p>

    <ul class="nav nav-tabs">
      <li class="initial-population"><a href="#initialPopulation" data-toggle="tab">initial pop.</a></li>
      <li class="active denominator"><a href="#eligibilityMeasures" data-toggle="tab">denominator</a></li>
      <li class="numerator"><a href="#outcomeMeasures" data-toggle="tab">numerator</a></li>
      <li class="exclusions"><a href="#exclusionMeasures" data-toggle="tab">exclusions</a></li>
      <li id="selector">
        <select>
          <option value="<%= url_for :population => nil, :action => 'definition' %>">Population Criteria 1</option>
          <% current = 1 %>
          <% while (@measure.population_criteria["NUMER_#{current}"]) do %>
            <option value="<%= url_for :population => current, :action => 'definition' %>"<%= ' selected="selected"' if current == params[:population].to_i%>>Population Criteria <%= current += 1 %></option>
          <% end if @measure.population_criteria %>
        </select>
      </li>
    </ul>

    <div class="tab-content" id="measureEditContainer">
      <div id="workspace" style="padding:10px;border-radius:12px;margin:10px;border:1px solid #aaa;background-color:#f5f5f5;float:right;width:340px;height:700px">
        <p>Workspace edit controls go here</p>
      </div>

      <div id="initialPopulation" class="tab-pane">
        <div class="measureBox">
          <div id="initialPopulationItems"></div>
        </div>
      </div>

      <div id="eligibilityMeasures" class="tab-pane active">
        <div class="measureBox">
          <div id="eligibilityMeasureItems"></div>
        </div>
      </div>

      <div id="outcomeMeasures" class="tab-pane">
        <div class="measureBox">
          <div id="outcomeMeasureItems"></div>
        </div>
      </div>

      <div id="exclusionMeasures" class="tab-pane">
        <div class="measureBox">
          <div id="exclusionMeasureItems"></div>
        </div>
      </div>
    </div>

  </div><!-- end #tabs -->
  <div class="modal hide fade in" id="publishConfirm">
    <div class="modal-header">
      <h3>PUBLISH</h3>
    </div>
    <div class="modal-body">
      <p>Your measure will be published as:</p>
      <table>
        <tbody>
          <tr>
            <td>NQF#</td>
            <td><%= @measure.measure_id %></td>
          </tr>
          <tr>
            <td>Title</td>
            <td><%= @measure.title %></td>
          </tr>
          <tr>
            <td>Version</td>
            <td><%= (@measure.version || 0) + 1 %></td>
          </tr>
          <tr>
            <td>Date</td>
            <td><%= Time.now().strftime('%D') %></td>
          </tr>
          <tr>
            <td>Publisher</td>
            <td><%= current_user.last_name.capitalize + ', ' + current_user.first_name.capitalize %></td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="modal-footer">
      <button class="close btn" data-dismiss="modal">Close</button>
      <%= form_tag(:action => 'publish') do %>
        <input type="submit" class="btn btn-primary" value="Publish"></a>
      <% end %>
    </div>
  </div>
<% end -%>
