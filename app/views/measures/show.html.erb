<% content_for :head do %>
  <script type="text/javascript">
    var bonnie = bonnie || {};

    var flushDrop = function(e){
      e = e || $('.dragged').parents('.temporal_drop_zone');
      $(e).find('.temporal_reference_value').val('');
      $(e).find('.temporal_drop_label').text('Drop Reference Here');
      $(e).find('.close').hide();
      $(e).removeClass('fullDrop');
      if ($(e).siblings('.temporal_drop_zone').length) $(e).remove();
    }

    var fillDrop = function(obj, id){
      // Populate id from possible sources in order [provided argument, hidden value in form, dragged element]
      id = id || $(obj).find('.temporal_reference_value').val() || $('.dragged').data('criteria-id');

      // Set target based on event object or given drop zone
      obj = (obj.target && ($(obj.target).hasClass('temporal_drop_zone') ? obj.target : $(obj.target).parents('.temporal_drop_zone'))) || obj;

      // Disallow dropping a reference on a reference
      if ($('[data-criteria-id=' + id + ']').hasClass('temporal_drop_zone_element')) return;

      // Expand children criteria of temporal references
      if (bonnie.builder.data_criteria[id] && bonnie.builder.data_criteria[id].type == 'derived' && bonnie.builder.data_criteria[id].children_criteria.length){
        $.each(bonnie.builder.data_criteria[id].children_criteria,
          function(i, e){
            fillDrop($('#bonnie_tmpl_data_criteria_temporal_drop_zone').tmpl().insertBefore(obj), e);
          }
        );
        $(obj).remove();
        return;
      }

      //Populate hidden form field
      $(obj).find('.temporal_reference_value').val(id);

      // Populate drop zone with element (or text if none available)
      var $e
      $(obj).find('.temporal_drop_label').empty().append(
        id ? (
          $(obj).find('.close').show() &&
          $(obj).addClass('fullDrop') &&
          ($e = $('.paramText[data-criteria-id=' + id + ']')).length ? $e.first().clone() : $(document.createElement('div')).attr('draggable', 'true').text(id)
        ).addClass('temporal_drop_zone_element') : 'Drop Reference Here'
      );
    }

    var page = new Page(<%= @measure.all_data_criteria.to_json.html_safe %>, <%= @measure.measure_period.to_json.html_safe %>);
    
    $(document).ready(function() {
      page.initialize();

      // Set location hash to track selected population
      $.getJSON($.bbq.getState('population') || "<%= url_for :action => 'definition' %>", bonnie.builder.renderMeasureJSON);

      // Animate the open/close of the control panel
      $("#measureDetailBorder").click(function() {
        var md = $("#measureDetailInformation");
        md.css('left') == '0px' ?
          md.find('.inner').animate({right: 285}) | md.animate({left: -285}) | $("#tabs").animate({'margin-left': 15}) :
          md.animate({left: 0}) | md.find('.inner').animate({right: 0}) | $("#tabs").animate({"margin-left": 300});
        $("#measureDetailBorder i").toggleClass("icon-backward").toggleClass("icon-forward");
      });

      var measureDetail = $("#measureDetailInformation");
      var matchTitleHeight = function() {
        var h = $("h1.measure-title").height();
        measureDetail.css("padding-top",h+20);
        measureDetail.find("#measureDetailBorder i").css("margin-top",h+30);
      };

      $(window).on("resize",matchTitleHeight);
      matchTitleHeight();
      $(".paramChildren label").draggable({helper:"clone",containment:'document',revert:true,zIndex:3000,distance:3,opacity:"1", start:function(){$(this).data("item",new queryStructure.AND(null, [],false))}});

      $('#selector > select').change(
        function(){
          $.bbq.pushState({population: $(this).val()});
          change_test_button_params($(this).val()); // measure debugger needs to know about multiple populations
          $("#initialPopulationItems, #eligibilityMeasureItems, #outcomeMeasureItems, #exclusionMeasureItems, #exceptionMeasureItems").empty();
          $.getJSON($(this).val(), bonnie.builder.renderMeasureJSON);
        }
      )

      $(document.body).on('dragstart', '.logicLeaf, div[data-criteria-id=MeasurePeriod], .temporal_drop_zone_element, #dataCriteria label',
        function(e){
          if (e.originalEvent.dataTransfer) e.originalEvent.dataTransfer.setData('text', 'arbitrary data');
          if (!$(e.target).hasClass('temporal_drop_zone_element')){
            $('#bonnie_tmpl_data_criteria_temporal_drop_zone').tmpl().insertAfter($('.temporal_reference .temporal_drop_zone.fullDrop:last-child'));
          }
          $(e.target).addClass('dragged');
        }
      );
      $(document.body).on('dragover',
        function(e){
          //e.preventDefault();
          if (!$('.dragged').hasClass('temporal_drop_zone_element') ^ !($.inArray(e.target, $('.temporal_drop_zone, .temporal_drop_zone *')) > -1)) e.preventDefault();
        }
      );

      $(document.body).on('drop',
        function(e){
          // Fill the drop zone if element is dropped there
          if ($(e.target).parents('.temporal_drop_zone').length) fillDrop(e);

          // Else if element was dragged off of the drop zone, flush that zone
          else if ($('.dragged').hasClass('temporal_drop_zone_element')) flushDrop();

          // Fixes FF redirect bug
          e.preventDefault();
        }
      );

      $(document.body).on('dragend',
        function(){
          $('.temporal_reference .temporal_drop_zone:not(.fullDrop)').filter(function(){return $(this).siblings('.temporal_drop_zone').length;}).remove();
          $('.dragged').removeClass('dragged');
        }
      );

      $(document.body).on('click', '.temporal_reference > .close, .subset_operator > .close',
        function(e){
          $(e.target).parent().parent().remove();
        }
      );

      $(document.body).on('click', '.temporal_drop_zone .close',
        function(e){
          flushDrop($(e.target).parent());
        }
      );

      $('#workspace').on('click', '#temporal_new',
        function(){
          $('#bonnie_tmpl_data_criteria_temporal_reference').tmpl().insertBefore('#temporal_new_position');
        }
      );

      $('#workspace').on('click', '#subset_new',
        function(){
          $('#bonnie_tmpl_data_criteria_subset_operator').tmpl().insertBefore('#subset_new_position');
        }
      );

      $('#workspace').on('change', '.subset_operator .subset_range_type',
        function(){
          $(this).parent().siblings().children('.subset_range_type').attr('checked', null);
          if ($(this).val() == 'value'){
            $(this).parents('.subset_operator').find('.subset_value').show();
            $(this).parents('.subset_operator').find('.subset_range').hide();
          } else {
            $(this).parents('.subset_operator').find('.subset_value').hide();
            $(this).parents('.subset_operator').find('.subset_range').show();
          }
        }
      );

    });

  </script>

  <script type="text/html" id="bonnie_tmpl_param_group">
    <div class='paramGroup'>
      <div class='paramItem'></div>
    </div>
  </script>

  <script type="text/html" id="bonnie_tmpl_data_criteria_logic">
    <div draggable="true" class='paramText {{if category}}${category}{{/if}} logicLeaf' {{if id}}data-criteria-id='${id}'{{/if}}>
      {{if operator}}<label>${operator}</label>{{/if}}
      {{if category}}<label>${category}</label>{{/if}}
      ${title} {{if value}}${valueText}{{/if}}${temporalText}
    </div>
  </script>

  <script type="text/html" id="bonnie_tmpl_data_criteria_temporal_drop_zone">
    <div draggable="true" class="temporal_drop_zone paramItem">
      <input class="temporal_reference_value" type="hidden"{{if reference}} value="${reference}"{{/if}} />
      <div class="temporal_drop_label">Drop Reference Here</div>
      <div class="close">&times;</div>
    </div>
  </script>

  <script type="text/html" id="bonnie_tmpl_data_criteria_temporal_reference">
    <tr>
      <td>Temporal:</td>
      <td class="temporal_reference">
        <div style="text-align: right;" class="close">&times;</div>
        <div>
          <select class="temporal_type">
            <option value="CONCURRENT">Concurrent with</option>
            <option value="DURING">During</option>
            <option value="EAE">Ends After End of</option>
            <option value="EAS">Ends After Start of</option>
            <option value="EBE">Ends Before End of</option>
            <option value="EBS">Ends Before Start of</option>
            <option value="ECW">Ends Concurrent with</option>
            <option value="EDU">Ends During</option>
            <option value="SAE">Starts After End of</option>
            <option value="SAS">Starts After Start of</option>
            <option value="SBE">Starts Before End of</option>
            <option value="SBS">Starts Before Start of</option>
            <option value="SCW">Starts Concurrent with</option>
            <option value="SDU">Starts During</option>
          </select>
        </div>
        <div>
          <select class="temporal_relation" style="width: 60px;">
            <option value="gt">&gt;</option>
            <option value="gte">&gt;=</option>
            <option value="lte">&lt;=</option>
            <option value="lt">&lt;</option>
          </select>
          <input class="temporal_value" type="text" style="width: 60px;" value=""/>
          <select class="temporal_unit" style="width: 80px;">
            <option value="a">yrs</option>
            <option value="d">days</option>
            <option value="h">hrs</option>
            <option value="min">mins</option>
            <option value="mo">mo.</option>
            <option value="s">secs</option>
            <option value="wk">wks</option>
          </select>
        </div>
        {{tmpl '#bonnie_tmpl_data_criteria_temporal_drop_zone'}}
      </td>
    </tr>
  </script>

  <script type="text/html" id="bonnie_tmpl_data_criteria_subset_operator">
    <tr>
      <td>Subset:</td>
      <td class="subset_operator">
        <div style="text-align: right;" class="close">&times;</div>
        <div>
          <select class="subset_type">
            <option value="COUNT">COUNT</option>
            <option value="FIRST">FIRST</option>
            <option value="SECOND">SECOND</option>
            <option value="THIRD">THIRD</option>
            <option value="FOURTH">FOURTH</option>
            <option value="FIFTH">FIFTH</option>
            <option value="RECENT">RECENT</option>
            <option value="LAST">LAST</option>
            <option value="MIN">MIN</option>
            <option value="MAX">MAX</option>
          </select>
        </div>
        <div>
          <label><input type="radio" class="subset_range_type" value="value" />Value</label>
          <label><input type="radio" class="subset_range_type" value="range" />Range</label>
        </div>
        <div class="subset_value">
          <div>
            <input class="subset_relation" type="hidden" value="eq">
            <input class="subset_value_value" type="text" style="width: 120px;" value="{{if range}}${range.low && range.low.value || ''}{{/if}}"/>
            <input class="subset_value_unit" style="width: 60px;" value="{{if range}}${range.low && range.low.unit || ''}{{/if}}" />
          </div>
        </div>
        <div class="subset_range">
          <div>
            <div>Low</div>
            <select class="subset_range_low_relation" style="width: 60px;">
              <option value="gt">&gt;</option>
              <option value="gte">&gt;=</option>
            </select>
            <input class="subset_range_low_value" type="text" style="width: 60px;" value="{{if range}}${range.low && range.low.value || ''}{{/if}}"/>
            <input class="subset_range_low_unit" style="width: 60px;" value="{{if range}}${range.low && range.low.unit || ''}{{/if}}" />
          </div>
          <div>
            <div>High</div>
            <select class="subset_range_high_relation" style="width: 60px;">
              <option value="lte">&lt;=</option>
              <option value="lt">&lt;</option>
            </select>
            <input class="subset_range_high_value" type="text" style="width: 60px;" value="{{if range}}${range.high && range.high.value || ''}{{/if}}"/>
            <input class="subset_range_high_unit" style="width: 60px;" value="{{if range}}${range.high && range.high.unit || ''}{{/if}}" />
          </div>
        </div>
      </td>
    </tr>
  </script>

  <script type="text/html" id="bonnie_tmpl_data_criteria_edit">
    <div style="position: relative; border-radius:12px;padding:10px; border:1px solid #aaa;background-color:#CCC;">
    <div style="width: 0px; height: 0px;"><!-- This is crap. --><div class="arrow-w" style="position: relative; top: 45px; left: -86px;"></div></div>
      <%= form_tag({:action => 'upsert_criteria'}, {:onsubmit => "return bonnie.builder.editDataCriteria_submit(this)"}) do %>
        <input type="hidden" name="id" value="<%= params[:id] %>" />
        <input type="hidden" name="criteria_id" value="${id}">
        <h4>${title}</h4>
        <table>
          <tr>
            <td>Status:</td>
            <td>
              <select name="status">
                <option value="">--</option>
                <option value="ordered">Ordered</option>
                <option value="administered">Administered</option>
                <option value="active">Active</option>
                <option value="performed">Performed</option>
              </select>
            </td>
          </tr>
          <tr>
            <td>Standard Category:</td>
            <td>
              <select name="standard_category">
                <option value="">--</option>
                <option value="problem">Problem</option>
                <option value="labresults">LabResults</option>
                <option value="laboratory test">Laboratory Test</option>
                <option value="procedure">Procedure</option>
                <option value="medication">Medication</option>
                <option value="rx">RX</option>
                <option value="demographics">Demographics</option>
                <option value="derived">Derived</option>
                <option value="care_goal">Care Goal</option>
                <option value="care_plan">Care Plan</option>
                <option value="communication">Communication</option>
                <option value="device">Device</option>
                <option value="diagnosis">diagnosis</option>
                <option value="diagnostic_study">diagnostic study</option>
                <option value="encounter">encounter</option>
                <option value="functional_status">functional status</option>
                <option value="individual_characteristic">individual characteristic</option>
                <option value="intervention">intervention</option>
                <option value="laboratory_test">laboratory test</option>
                <option value="medication">medication</option>
                <option value="patient_care_experience">patient care experience</option>
                <option value="patient_preference">patient preference</option>
                <option value="physical_exam">physical exam</option>
                <option value="procedure">procedure</option>
                <option value="provider">provider</option>
                <option value="risk_category_assessment">risk category assessment</option>
                <option value="substance">substance</option>
                <option value="symptom">symptom</option>
                <option value="system_characteristic">system characteristic</option>
                <option value="transfer_from">transfer from</option>
                <option value="transfer_to">transfer to</option>
              </select>
            </td>
          </tr>
          {{each temporal_references}}
            {{tmpl($value) '#bonnie_tmpl_data_criteria_temporal_reference'}}
          {{/each}}
          <tr id="temporal_new_position">
            <td></td>
            <td><input type="button" id="temporal_new" value="New Temporal Reference" /></td>
          </tr>
          {{each subset_operators}}
            {{tmpl($value) '#bonnie_tmpl_data_criteria_subset_operator'}}
          {{/each}}
          <tr id="subset_new_position">
            <td></td>
            <td><input type="button" id="subset_new" value="New Subset Operator" /></td>
          </tr>
          <tr>
            <td></td>
            <td>
              <input type="submit" value="save">
              <span id="edit_save_message"></span>
            </td>
          </tr>
          </tr>
        </table>
      <% end %>
    </div>
  </script>


<% end %>

<% content_for :page_content do %>

  <div class="pull-right" id="pageButtons">
    <a href="#" class="btn" >Save</a>
    <%= link_to 'Test', test_measure_url(@measure), :class => 'btn' %>
    <a class="btn" data-toggle="modal" data-show="false" href="#publishConfirm">Publish</a>
  </div>
	<h1 class="measure-title"><%= "#{@measure.endorser}#{@measure.measure_id}: #{@measure.title}" %></h1>


  <div id="measureDetailInformation">
    <div id="measureDetailBorder"><i class="icon-backward icon-white"></i></div>
    <div class="inner" style="position:relative; margin:15px 20px 15px 15px;">
      <dl>
        <dt>Reporting Period:</dt>
        <dd>
          <span id="measurementPeriod"><% @measure.measure_period %></span>
        </dd>
      </dl>
      <dl>
        <dt>Description:</dt>
         <dd>
           <span id="measureDescText"><%= @measure.description %></span>
         </dd>
      </dl>
      <% if @measure.published %>
        <dl>
          <dt>Version</dt>
          <dd><%= "#{@measure.version} as of #{@measure.publish_date}" %></dd>
        </dl>
      <% end %>
      <%= link_to 'Export', export_measure_path(@measure) %> |
      <%= link_to 'Edit', edit_measure_path(@measure) %> |
      <%= link_to 'NQF Definition', show_nqf_measure_path(@measure), :target => "_blank" %> |
      <%= link_to 'Back', measures_path %>

      <div id="dataCriteria">
        <%= render partial: 'data_criteria', locals: {criteria_by_category: data_criteria_by_category(@measure.source_data_criteria)}%>
      </div>
    </div>
  </div>

  <!-- start tab nav -->
  <div id="tabs" class="measureDetailTable">

    <p id="notice"><%= notice %></p>

    <ul class="nav nav-tabs">
      <li class="initial-population"><a href="#initialPopulation" data-toggle="tab">initial pop.</a></li>
      <li class="active denominator"><a href="#eligibilityMeasures" data-toggle="tab">denominator</a></li>
      <li class="numerator"><a href="#outcomeMeasures" data-toggle="tab">numerator</a></li>
      <li class="exclusions"><a href="#exclusionMeasures" data-toggle="tab">exclusions</a></li>
      <li class="exceptions"><a href="#exceptionMeasures" data-toggle="tab">exceptions</a></li>
      <li id="selector">
        <select>
          <% @measure.populations.each_with_index do |population, index| %>
            <option value="<%= url_for :population => index, :action => 'definition' %>"<%= ' selected="selected"' if index == params[:population].to_i%>><%= population['title'] %></option>
          <% end if @measure.populations %>
        </select>
      </li>
    </ul>

    <div class="tab-content" id="measureEditContainer">
      <div id="workspace" style="padding:10px;border-radius:12px;margin:10px;border:1px solid #aaa;background-color:#f5f5f5;float:right;width:340px;min-height:700px">
        <p>Workspace edit controls go here</p>
      </div>

      <div id="initialPopulation" class="tab-pane">
        <div class="measureBox">
          <div id="initialPopulationItems"></div>
        </div>
      </div>

      <div id="eligibilityMeasures" class="tab-pane active">
        <div class="measureBox">
          <div id="eligibilityMeasureItems"></div>
        </div>
      </div>

      <div id="outcomeMeasures" class="tab-pane">
        <div class="measureBox">
          <div id="outcomeMeasureItems"></div>
        </div>
      </div>

      <div id="exclusionMeasures" class="tab-pane">
        <div class="measureBox">
          <div id="exclusionMeasureItems"></div>
        </div>
      </div>

      <div id="exceptionMeasures" class="tab-pane">
        <div class="measureBox">
          <div id="exceptionMeasureItems"></div>
        </div>
      </div>
    </div>

  </div><!-- end #tabs -->
  <div class="modal hide fade in" id="publishConfirm">
    <div class="modal-header">
      <h3>PUBLISH</h3>
    </div>
    <div class="modal-body">
      <p>Your measure will be published as:</p>
      <table>
        <tbody>
          <tr>
            <td>NQF#</td>
            <td><%= @measure.measure_id %></td>
          </tr>
          <tr>
            <td>Title</td>
            <td><%= @measure.title %></td>
          </tr>
          <tr>
            <td>Version</td>
            <td><%= (@measure.version || 0) + 1 %></td>
          </tr>
          <tr>
            <td>Date</td>
            <td><%= Time.now().strftime('%D') %></td>
          </tr>
          <tr>
            <td>Publisher</td>
            <td><%= current_user.last_name.capitalize + ', ' + current_user.first_name.capitalize %></td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="modal-footer">
      <button class="close btn" data-dismiss="modal">Close</button>
      <%= form_tag(:action => 'publish') do %>
        <input type="submit" class="btn btn-primary" value="Publish"></a>
      <% end %>
    </div>
  </div>
<% end -%>
