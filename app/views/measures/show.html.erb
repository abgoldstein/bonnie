<% content_for :head do %>
  <script type="text/javascript">
    var bonnie = bonnie || {};
    bonnie.renderMeasureJSON = function(data) {
        var measure = data;
        var elemParent;
        var addParamItems = function(obj,elemParent,container) {
          var items = obj["items"]
          
          if ($.isArray(items)) {
            var conjunction = obj['conjunction'];
            // add the grouping container
            if (!container) {elemParent = $("#ph_tmpl_paramGroup").tmpl({}).appendTo(elemParent).find(".paramItem:last");}
              $.each(items,function(i,node) {
                addParamItems(node,elemParent);
                if (i < items.length-1) {
                  next = items[i+1]
                  var negation = ''
                  if (next['negation']) negation = ' not'
                  $(elemParent).append("<span class='"+conjunction+negation+"'>"+conjunction+negation+"</span>");
                }
              });
            } else {
              // we dont have a nested measure clause, add the item to the bottom of the list
              if (!elemParent.hasClass("paramItem")) {
                elemParent = $("#ph_tmpl_paramGroup").tmpl({}).appendTo(elemParent).find(".paramItem:last");
              }
              $("#ph_tmpl_paramItem").tmpl(obj).appendTo(elemParent);
            }
        } // end addParamItems

        if (data.population) {
          elemParent = $("#ph_tmpl_paramGroup").tmpl({}).appendTo("#eligibilityMeasureItems").find(".paramItem:last");
          addParamItems(data.population,elemParent,elemParent);
          elemParent.parent().addClass("population");
        }

        if (!$.isEmptyObject(data.denominator)) {
          $("#eligibilityMeasureItems").append("<span class='and'>and</span>");
          addParamItems(data.denominator,$("#eligibilityMeasureItems"));
        }

        if (data.numerator) {
          addParamItems(data.numerator,$("#outcomeMeasureItems"));
        }

        if ('exclusions' in data && !$.isEmptyObject(data['exclusions'])) {
          addParamItems(data.exclusions,$("#exclusionMeasureItems"));
          $("#exclusionMeasureItems").hide();
          $("#exclusionPanel").show();
        }
        
        $('.logicLeaf').click(function(element) {
          var leaf = $(element.currentTarget);
          offset = leaf.offset().top - $('#workspace').offset().top
          bonnie.showDataCriteria(leaf.data('id'), offset);
        });
        
     }
    
    $(document).ready(function() {
      $('#dataCriteria .paramGroup').click(function(element) {
        var category = $(element.currentTarget).data('category');
        var children = $('.'+category+'_children')
        if (children.is(':visible')){
          children.hide("blind", { direction: "vertical" }, 500);
        } else{
          children.show("blind", { direction: "vertical" }, 500);
        }
      });
      $('.nav-tabs li').click(function(element) {
        if (!$(element.currentTarget).hasClass('active'))
        $('#workspace').empty();
      })
      $.getJSON("<%= definition_measure_url(@measure) %>", bonnie.renderMeasureJSON);
    });
    
    bonnie.showDataCriteria = function(id, offset) {
      data_criteria = bonnie.all_data_criteria[id]
      $('#workspace').empty();
      element = $("#bonnie_tmpl_data_criteria").tmpl(data_criteria)
      element.appendTo($('#workspace'));
      offset = offset - element.height()/2
      element.css("top",offset)
    }
    bonnie.getValue = function(value) {
      if (value.low) {
        return value.low.value
      } else if (value.high) {
        return value.high.value
      } 
      
      return ""
    }
    
    bonnie.all_data_criteria = <%= @measure.data_criteria.to_json.html_safe %>
  </script>
  
  <script type="text/html" id="ph_tmpl_paramItem">
    <div class='paramText {{if category}}${category}{{/if}} logicLeaf' {{if id}}data-id='${id}'{{/if}}>
      <!-- ${percentage=Math.round(Math.random()*100,2)} -->
      {{if category}}<label>${category}</label>{{/if}}
      ${title}
    </div>
  </script>
  <script type="text/html" id="ph_tmpl_paramGroupContainer">
    <div class="paramGroupContainer"></div>
  </script>
  <script type="text/html" id="ph_tmpl_paramGroup">
    <div class="paramGroup">
      <div class="paramItem"></div>
    </div>
  </script>
  <script type="text/html" id="bonnie_tmpl_data_criteria">
    <div style="position: relative; border-radius:12px;padding:10px; border:1px solid #aaa;background-color:#CCC;">
    <div style="width: 0px; height: 0px;"><!-- This is crap. --><span class="arrow-w" style="position: relative; top: 45px; left: -88px;"></span></div>
      <div>${title}</div>
      <table>
        <tr>
          <td>Status:</td>
          <td>
            <select style="width: 100px;">
              <option value="">--</option>
              <option value="ordered">Ordered</option>
              <option value="ordered">Administered</option>
              <option value="ordered">Active</option>
            </select>
          </td>
        </tr>
        <tr>
          <td>Type:</td>
          <td>
            <select style="width: 100px;">
              <option value="">--</option>
              <option value="ordered">encounter outpatient</option>
            </select>
          </td>
        </tr>
        <tr>
          <td>Temporal:</td>
          <td>
            <select style="width: 100px;">
              <option value="">--</option>
              <option value="ordered">Starts Before Start</option>
            </select>
          </td>
        </tr>
        <tr>
          <td>Value:</td>
          <td>
            <select style="width: 100px;">
              <option value="">--</option>
              <option value="ordered">Equal to</option>
              <option value="ordered">Greater than</option>
              <option value="ordered">Less Than</option>
            </select>
          </td>
          <td>
            <input type="text" style="width: 100px;" value="{{if value}}${bonnie.getValue(value)}{{/if}}"/>
          </td>
        </tr>
      </table>
    </div>
  </script>
  
  
<% end %>

<% content_for :right_column do %>
<div style="position:relative;top:0;margin:0;padding-top:10px;">
  <div class="pull-right" id="pageButtons">
    <a href="#" class="btn" >Save</a>
    <%= link_to 'Test', debug_measure_url(@measure), :class => 'btn' %>
    <a href="#" class="btn">Publish</a>
    <%# link_to 'Publish', publish_measure_path(@measure), class:"btn" %>
  </div>
	

<h1 class="measure-title"><%= "#{@measure.endorser}#{@measure.measure_id}: #{@measure.title}" %></h1>
<div id="measureDetailInformation">
    <dl>
      <dt>Reporting Period:</dt>
      <dd>
        <span id="measurementPeriod"><% @measure.measure_period %></span>
      </dd>
    </dl>
    <dl>
      <dt>Description:</dt>
       <dd>
         <span id="measureDescText"><%= @measure.description %></span>
       </dd>
    </dl>
    <% if @measure.published %>
      <dl>
  		  <dt>Version</dt>
    		<dd><%= "#{@measure.version} as of #{@measure.publish_date}" %></dd>
  	  </dl>
    <% end %>
  <%= link_to 'Export', export_measure_path(@measure) %> |
  <%= link_to 'Publish', publish_measure_path(@measure) %> |
	<%= link_to 'Edit', edit_measure_path(@measure) %> |
	<%= link_to 'NQF Definition', show_nqf_measure_path(@measure), :target => "_blank" %> |
	<%= link_to 'Back', measures_path %>

    <div id="dataCriteria">
      <%= render partial: 'data_criteria', locals: {criteria_by_category: @measure.data_criteria_by_category}%>
    </div>
</div>
<!-- start tab nav -->
<div id="tabs" class="measureDetailTable">
  
  <p id="notice"><%= notice %></p>

  <ul class="nav nav-tabs">
    <li class="initial-population"><a href="#initialPopulation" data-toggle="tab">initial pop.</a></li>
    <li class="active denominator"><a href="#eligibilityMeasures" data-toggle="tab">denominator</a></li>
    <li class="numerator"><a href="#outcomeMeasures" data-toggle="tab">numerator</a></li>
  </ul>

  <div class="tab-content" id="measureEditContainer">
    <div id="workspace" style="padding:10px;border-radius:12px;margin:10px;border:1px solid #aaa;background-color:#f5f5f5;float:right;width:340px;height:1000px">
      <p>Workspace edit controls go here</p>
    </div>
    

    
    <div id="initialPopulation" class="tab-pane">
      <div class="measureBox">
        <div id="initialPopulationItems"></div>
      </div>
    </div>
    
    <div id="eligibilityMeasures" class="tab-pane active">
      <div class="measureBox">
        <div id="eligibilityMeasureItems"></div>
      </div>
    </div>
    
    <div id="outcomeMeasures" class="tab-pane">
      <div class="measureBox">
        <div id="outcomeMeasureItems"></div>
      </div>
    </div>
  </div>

</div><!-- end #tabs -->
</div>

<% end -%>