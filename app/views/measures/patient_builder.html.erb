<% content_for :head do %>
  <script type="text/javascript">

  var page = new PatientBuilderPage(
    <%= @measure.all_data_criteria.to_json.html_safe %>,
    <%= @measure.value_sets.to_json.html_safe %>
  );

  $(document).ready(function() {
    page.initialize();

    $('#birthdate').datepicker();

    $('#measure_period_start').datepicker({
      onSelect: function(selectedDate) {$( "#measure_period_end" ).datepicker( "option", "minDate", selectedDate );onLoadTimeline();}
    });
    $('#measure_period_end').datepicker({
      onSelect: function(selectedDate) {$( "#measure_period_start" ).datepicker( "option", "maxDate", selectedDate );onLoadTimeline();}
    });
    $('.timepicker-default').timepicker();

    onLoadTimeline();

    $(".paramChildren label").not('[data-criteria-id=MeasurePeriod] label').draggable({
      helper: "clone",
      containment: 'document',
      revert: false,
      zIndex: 3000,
      distance: 3,
      opacity: "1",
    });

    $('#patient_data_criteria').droppable({ tolerance: 'pointer', greedy: true, accept: 'label.ui-draggable', drop: function(e,obj){ return fillDrop(e,obj); } });

  });

  var fillDrop = function(event, obj){
    var id = $(obj.draggable).data('criteria-id');
    var source_data_criteria = bonnie.patientBuilder.dataCriteria(id)
    var data_criteria = source_data_criteria.duplicate(id+'_'+bonnie.patientBuilder.nextDataCriteriaId())
    html = data_criteria.asHtml('data_criteria')
    $(event.target).append(html)
    bonnie.patientBuilder.registerDataCriteria(data_criteria);
    html.click(function(event) {
      bonnie.patientBuilder.editDataCriteria(event.currentTarget);
      data_criteria = bonnie.patientBuilder.selectedDataCriteria($(event.currentTarget).data('criteria-id'))
      bonnie.patientBuilder.timelineToDataCriteria(data_criteria);
    });
    $('.paramGroup[data-criteria-id='+data_criteria.id+'] .removeDataCriteria').click(function(event) {
      bonnie.patientBuilder.detachDataCriteria(data_criteria);
      event.stopPropagation();
    });
  }

  </script>
  <!-- Load the Timeline library after reseting the fonts, etc -->
  <script src="http://static.simile.mit.edu/timeline/api-2.3.0/timeline-api.js?bundle=true" type="text/javascript"></script>


  <script type="text/javascript">
       var tl;
       function onLoadTimeline() {

           var timeline_data = {
           'dateTimeFormat': 'iso8601',
           'events' : []
           }

           var tl_el = document.getElementById("tl");
           var eventSource1 = new Timeline.DefaultEventSource();

           var theme = Timeline.ClassicTheme.create();
           theme.event.bubble.width = 250;
           theme.autoWidth = true; // Set the Timeline's "width" automatically.
                                    // Set autoWidth on the Timeline's first band's theme,
                                    // will affect all bands.
           theme.timeline_start = new Date(Date.UTC(1995, 0, 1));
           theme.timeline_stop  = new Date(Date.UTC(2015, 0, 1));



           var date = "2011-01-01T05:00:00Z"
           if (bonnie.timeline) {
             date = bonnie.timeline.getBand(0).getCenterVisibleDate().toString();
           }
           var bandInfos = [
               Timeline.createBandInfo({
                   width:          '100%',
                   intervalUnit:   Timeline.DateTime.DAY,
                   intervalPixels: 80,
                   eventSource:    eventSource1,
                   date:           date,
                   timeZone:       0,
                   theme:          theme
               }),
               Timeline.createBandInfo({
                   width:          "100%",
                   intervalUnit:   Timeline.DateTime.MONTH,
                   intervalPixels: 200,
                   overview:       true,
                   eventSource:    eventSource1,
                   date:           date,
                   timeZone:       0,
                   theme:          theme
               }),
               Timeline.createBandInfo({
                   width:          "100%",
                   intervalUnit:   Timeline.DateTime.YEAR,
                   intervalPixels: 300,
                   eventSource:    eventSource1,
                   date:           date,
                   timeZone:       0,
                   overview:       true,
                   theme:          theme
               })
           ];

           bandInfos[1].syncWith = 0;
           bandInfos[1].highlight = true;
           bandInfos[2].syncWith = 0;
           bandInfos[2].highlight = true;

           for (var i = 0; i < bandInfos.length; i++) {
               bandInfos[i].decorators = [
                   new Timeline.SpanHighlightDecorator({
                       startDate:  bonnie.patientBuilder.getDateString($('#measure_period_start').val(),'12:00 AM'),
                       endDate:    bonnie.patientBuilder.getDateString($('#measure_period_end').val(),'12:00 AM'),
                       color:      "#FFC080",
                       opacity:    50,
                      // theme:      theme,
                      cssClass: 't-highlight1'
                   })
                ];
           }


           // create the Timeline
           tl = Timeline.create(tl_el, bandInfos, Timeline.HORIZONTAL);

           var url = '.'; // The base url for image, icon and background image
                          // references in the data

           eventSource1.loadJSON(timeline_data, url); // The data was stored into the
                                                     // timeline_data variable.

           tl.layout(); // display the Timeline

           bonnie.timeline = tl;
           bonnie.timelineEvents = eventSource1

           bonnie.timeline.getBand(0).addOnScrollListener(function(band) {
             minDate = band.getMinVisibleDate();
             maxDate = band.getMaxVisibleDate();
             bonnie.patientBuilder.highlightSelectedDataCriteria(minDate,maxDate);
           });

       }

       var resizeTimerID = null;
       function onResize() {
           if (resizeTimerID == null) {
               resizeTimerID = window.setTimeout(function() {
                   resizeTimerID = null;
                   tl.layout();
               }, 500);
           }
       }


  </script>


  <script type="text/html" id="bonnie_tmpl_data_criteria">
    <div class="paramGroup population" {{if id}}data-criteria-id='${id}'{{/if}}>
      <div class='paramItem logicLeaf'>
        <div class="close removeDataCriteria" style="text-align: right; float: right;">&times;</div>
        <div class='paramText {{if category}}${category}{{/if}}'>
          {{if operator}}<label>${operator}</label>{{/if}}
          {{if category}}<label>{{if specific_occurrence}}<span class="occurrence">Occurrence ${specific_occurrence}:</span>{{/if}} ${category}{{if status}}, ${status}{{/if}}</label>{{/if}}
          ${title} {{if value }}{{if type!='characteristic' }}${valueText}{{/if}}{{/if}} ${fieldsText} ${temporalText}
          <div class="negation_text">{{if negation}} <b>not done:</b> {{if negation_code_list_id}}${bonnie.builder.value_sets[negation_code_list_id].concept}: ${bonnie.builder.value_sets[negation_code_list_id].description}{{/if}}{{/if}}</div>
        </div>
      </div>
    </div>
  </script>

  <script type="text/html" id="bonnie_tmpl_data_criteria_edit">
  <div style="position: relative; border-radius:12px;padding:10px; border:1px solid #aaa;background-color:#CCC;">
    <span class="close_edit" style="position:absolute; top: 0; right: 0;">close</span>
    <div style="width: 0px; height: 0px;"><div class="arrow-w" style="position: relative; top: 45px; left: -86px;"></div></div>
      <h4>${title}</h4>
      <input type="hidden" value="${id}" id="element_id"/>

      <div class="row">
        <div class="span1">
          Event Start
        </div>
        <div class="span3">
          <input type="text" style="width: 150px;" value="01/01/2000 05:00 AM" data-date-format="mm/dd/yyyy" id="element_start" >
        </div>
      </div>

      <div class="row">
        <div class="span1">
          Event End
        </div>
        <div class="span3">
          <input type="text" style="width: 150px;" value="01/01/2000 05:00 AM" data-date-format="mm/dd/yyyy" id="element_end" >
        </div>
      </div>

      <div class="row">
        <div class="span1">
          &nbsp;
        </div>
        <div class="span3">
          <div class="span1" style="margin:0">
            scalar
          </div>
          <div class="span1">
            unit
          </div>
        </div>
      </div>
      <div class="row">
        <div class="span1">
        Value
        </div>
        <div class="span3">
          <div class="span1" style="margin:0">
            <input type="text" style="width: 60px;" value="" id="element_value" >
          </div>
          <div class="span1">
            <input type="text" style="width: 60px;" value="" id="element_value_unit" >
          </div>
        </div>
      </div>

      <div class="row">
        <div class="span4">
          <a href="javascript:void(0)" class="btn" id="element_update">Update</a>
          <a href="javascript:void(0)" class="btn" >Update/Next</a>
          <a href="javascript:void(0)" class="btn close_edit" >Cancel</a>
        </div>
      </div>

  </div>
  </script>

<% end %>

<% content_for :page_content do %>

  <div class="pull-right" id="pageButtons">
    <a href="#" class="btn">Save</a>
  </div>
	<h1 class="measure-title"><%= "#{@measure.endorser}#{@measure.measure_id}: #{@measure.title}" %></h1>


  <div id="measureDetailInformation" style="padding-top: 60px;">
    <div style="position:relative; margin:5px 20px 5px 15px;">

      <div>
        <div>
          Measure Period Start:
        </div>
        <div>
          <input type="text" value="01/01/2011" data-date-format="mm/dd/yyyy" id="measure_period_start" >
        </div>
        <div>
          Measure Period End:
        </div>
        <div>
          <input type="text" value="12/31/2011" data-date-format="mm/dd/yyyy" id="measure_period_end" >
        </div>
      </div>

      <%= link_to 'Measure Definition', measure_path(@measure), :target => "_blank" %> |
      <%= link_to 'Back', measures_path %>

      <div id="dataCriteria" style="overflow-y: auto; height: 650px;">
        <%= render partial: 'data_criteria', locals: {criteria_by_category: data_criteria_by_category(@measure.source_data_criteria)}%>
      </div>
    </div>
  </div>

  <!-- start tab nav -->
  <div id="tabs" class="measureDetailTable">

    <p id="notice"><%= notice %></p>

    <ul class="nav nav-tabs">
      <li class="patient-tab"><a href="#patient" data-toggle="tab">Patient</a></li>
    </ul>

    <div id="workspace" style="padding:10px;border-radius:12px;margin:10px;border:1px solid #aaa;background-color:#f5f5f5;float:right;width:340px;min-height:700px">
      <p>Workspace edit controls</p>
    </div>

    <div class="tab-content" id="measureEditContainer">
      <%= form_tag({:action => nil}, {:onsubmit => 'bonnie.patientBuilder.save_patient_builder(this); return false', :id => 'save_patient_builder'}) do %>
        <div style="margin: 5px 0 0 30px;">
          <div class="row">
            <div class="span4">
              First Name:
            </div>
            <div class="span4">
              <input type="text" name="first">
            </div>
          </div>
          <div class="row">
            <div class="span4">
              Last Name:
            </div>
            <div class="span4">
              <input type="text" name="last">
            </div>
          </div>
          <div class="row">
            <div class="span4">
              Gender:
            </div>
            <div class="span4">
              <select id="gender" name="gender">
                <option value="M" selected="selected">Male</option>
                <option value="F">Female</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div class="span4">
              Expired:
            </div>
            <div class="span4">
              <input type="radio" name="expired" checked="true" value="false" id="alive_radio" style="float:left;"/>
              <label for="alive_radio" style="float:left;">&nbsp;Alive&nbsp;</label>
              <input type="radio" name="expired" value="true" id="deceased_radio" style="float:left;"/>
              <label for="deceased_radio" style="float:left;">&nbsp;Deceased&nbsp;</label>
            </div>
          </div>
          <div class="row">
            <div class="span4">
              Birthdate:
            </div>
            <div class="span4">
              <div class="row">
                <div class="span2">
                  <input type="text" class="span2" value="01/01/2000" data-date-format="mm/dd/yyyy" id="birthdate" >
                </div>
                <div class="span2">
                  <input type="text" class="timepicker-default input-small">
                </div>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="span4" style="font-weight: bold">
              Clinical Attributes
            </div>
            <div class="span6" style="margin: 5px 0 0 40px; min-height: 300px; padding-left: 5px; border: 1px #CCC solid;" id="patient_data_criteria">
              &nbsp;
            </div>
          </div>

        </div>
      <% end %>
    </div>

  </div><!-- end #tabs -->

  <div style="width: 630px; margin-left: 310px; margin-top: 20px;">
  <div id='tl'></div>
  </div>

<% end -%>
